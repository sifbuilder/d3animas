<!DOCTYPE html>
<meta charset='utf-8'>
<title>animas</title>
<head >

  <style>
    body { margin: 0; position: fixed; top: 0; right: 0; bottom: 0; left: 0; }
    div#fps,svg { position: fixed; top: 0; left: 0; color: white; }
  </style>

</head>
<body style='cursor:crosshair'></body>
<div id='viewframe' class='viewframe'></div>
<script src='script-enls.js'></script>
<script src='script-ents.js'></script>

<script>

let muonAlima = function muonAlima (__mapper) {
  __mapper({'xs': xs.xs(__mapper)}) // PROXIES
  __mapper('xs').m('init')({canvas: 0, svg: 1, versor: 0, wen: 1, webgl: 0, img: 1, gui: 0, fps: 0, stats: 0}) // INIT

  let f = __mapper({props: muonProps.muonProps()}).props(),
    mnat = __mapper('xs').m('nat'),
    cwen = __mapper('xs').c('wen'),
    cversor = __mapper('xs').c('versor'),
    mstace = __mapper('xs').m('stace')

  const pi = Math.PI, pi2 = 2 * pi
  
  
  
  /*******************************************
 *      @animas
 */ 
 let tim = {'td': 111200, 't0': 0, 't1': 1000, 't2': 1, 't3': 1}
 
  /*******************************************
 *      @animas
 */
  let getForm = function (params = {}) {


  /***********
  *         @
  */
    const  ww0 = level => (PHASED, SIDES) => PHASED
    
    // const  ww1 = level => (PHASED, SIDES) => PHASED + ( (1-SIDES)**level ) * turnGrad
    const ww1 = level => (PHASED, SIDES) => PHASED + ( (-1)**level ) * ( (SIDES-1)**level ) * turnGrad
    
    const dd = level => rad0 => rad0 / (Math.pow(2, level))      // rad(level)(rad0)


  /***********
  *         @
  */
    let NAME = params.name || 'anis',
    ROW = params.row || 2,
    COL = params.col || 2,
    DEPTH = params.depth || 2,
    CF = params.cf || (d => 222 * 1), // cfonlevel

    SIDES = params.sides || 5,

    _RAD = params.rad || 90,
    PHASED = params.anginit || 0 // 0 internal, 180 extenal
     
      
    const cyclet = DEPTH * 2000
    const duration = cyclet * DEPTH
    
    
    const x0 = -150,
      dx = 150,
      y0 = -100,
      dy = 100,
      turnGrad = 360

    
    let x = x0 + (COL - 1) * dx,
        y = y0 + (ROW - 1) * dy

    const signexp = level => Math.pow(-1, level)

  // -------------------------------  img
  let img = {

    halo: 'img',

    geofold: p => ({
      type: 'Feature',
      geometry: {

        'type': 'Point',
        'coordinates': [ 0, 0 ]

      },
      properties: {
        sort: 'img',
        'xlink:href': p.payload.img.url,
        style: p.payload.img.style
      }
    }),

    payload: {

      // tim: {'td': duration, 't0': 0, 't1': 1000, 't2': 1, 't3': 1},
      ric: {'gid': 'imgg', 'cid': 'imgc', 'fid': 'imgf'},
      boform: { 'csx': 0, 'cf': [[[22, 22]]], 'cs': 22, 'cw': [[[0.7, 0.7]]], 'co': [[[0.7, 0.7]]], 'cp': [[[0.5, 0.5]]]},
      proform: {
        projection: 'uniwen',
        translate: [ 30, 40 ]
      },
      img: {
        url: 'zimg-501.jpg',
        'style': {
          'width': [[[60, 60]]],
          'height': [[[40, 40]]],
          'rotate': [[[ 0, 0 ]]]
        }
      }

    }
  }
    
  
  /***********
  *         @animas
  */


    let anima = {

      halo: 'ent',
      geofold: p => mnat.natFeature(p.payload.form),
      payload: {

        tim: tim, // {'td': duration, 't0': 0, 't1': 1000, 't2': 1, 't3': 1},
        ric: {gid: NAME, cid: NAME, fid: NAME},
        boform: {'csx': 0, 'cf': 555, 'cs': 333, 'cw': 0.9, 'co': 0.2, 'cp': 0.7},

        form: {
            'm1': 4, 'm2': 4, 'n1': 2, 'n2': 2, 'n3': 2, 'a': 1, 'b': 1, // circle
            'ra2': 30, 'v0': 0, 'v1': 1, 'w4': 0, 'seg5': 36, 'pa6': 0, 'pb7': -1
          },

          
        proform: {

        
          projection: 'orthographic',
          prerotate: [[[ cwen.rotation ]]],
          scale: 100,
        
        
          // projection: 'uniwen',
          // prerotate: [[[ cwen.rotation ]]],
          // scale: 1,
          translate: {
            x,
            y,
            z: 0
          },
          rotate: [ 0, 0, 0 ]

        }
      }
    }

    let traceLine = { // SUB-MARKS line trace

      halo: 'pacer',

      payload: {
        ric: {'gid': NAME + 'traces' + 0, 'cid': NAME + 'traces' + 0, 'fid': NAME + 'traces' + 0},
        boform: {'csx': 0, 'cf': 111, 'cs': 666, 'cw': 0.99, 'co': 0.2, 'cp': 0.99},

       stace: {
          x: { pos: 0 },
          y: { pos: 0 },
          z: 0,
        },
                  
        proform: {

          // projection: 'orthographic',
          // scale: 100,        
          
          prerotate: [[[ cwen.rotation ]]],
        
          projection: 'uniwen',
          prerotate: [[[ cwen.rotation ]]],
          scale: 1,
          // translate: null,
          // translate: { x: { pos: [[[0, 0]]] }, y: { pos: [[[0, 0]]] }, z: 0 },
          rotate: [ 0, 0, 0 ]

        },

        pacer: {
          initN: 0, eventN: 0, autoN: 1, autoP: 0.0001, outtimed: 0, maxN: 60, span: 0, aad: 1,

          autoSitus: ani => mstace.getLocus(ani.payload.stace, ani.payload),

          fider: ani => ani.payload.ric.fid,

          geojsor: ani => ({

            halo: 'ent',
            geofold: {
              type: 'Feature',
              geometry: {
                type: 'LineString',
                coordinates: []
              },
              properties: {}
            },
            payload: {}

          })

        }
      }
    }


    /***********
  *         @create animas
  */
    let anis = {} // initialize animas
    let traces = {} // initialize line trace on highest level avatar

  
    for (level = 0; level < DEPTH; level++) {

      // anis h.nat
      anis[level] = f.cloneObj(anis[level - 1] || anima)

      // cycloid ric
      anis[level].payload.ric = {
        gid: 'nat',
        cid: NAME + level,
        fid: NAME + level
      }

      // --------- Sr -------------- cycloid radius -
      anis[level].payload.form.ra2 = dd(level)(_RAD)

      // --------- Sw -------------- cycloid ROTATION
      anis[level].payload.form.w4 = [[[ ww0(level)(PHASED, SIDES), ww1(level)(PHASED, SIDES) ]]]


      anis[level].payload.boform.cf = CF(level)   // cycloid boform


      if (level !== 0) {    // POSITION for upper cycloids
        anis[level].payload.proform.translate = {  
          x: { 'pos': 0 }, 
          y: { 'pos': 0 }, 
          z: 0 
        } //  ref - pos : nb of vertex
      }
      
      traces[level] = f.cloneObj(traces[level - 1] || traceLine)
      traces[level].payload.ric = {
          gid: NAME + 'traces' + level, 
          cid: NAME + 'traces' + level, 
          fid: NAME + 'traces' + level
      }

      if (level === DEPTH) traces[level].payload.boform.cp = 1
    }

    // link sub cycloids as avatars
    
    for (level = DEPTH - 1; level >= 0; level--) { // DEPTH:3  2, 1, 0
      anis[level].payload.avatars = []

      if (anis[level + 1] !== undefined) {
        
        let avatar = anis[level + 1]

        anis[level].payload.avatars.push(avatar)
        
      }

      // add line trace avatar to upper level
      
      if (level === DEPTH - 1) {
          anis[level].payload.avatars.push(traces[level])
      }
      
      // add img avatar to upper level
      
      if (level === DEPTH - 1) {    // add image as avatar to root nat
        // anis[level].payload.avatars.push(img)
      }      
    }

    return anis[0]
  }
  

  /***********
  *         @animas
  */
  let forms = []
  // default: depth:2,rad:30,sides:5,wbase:1,anginit:180,name:"as11",row:1,col:1
  // forms.push(getForm({depth: 1, rad: 30, sides: 6, wbase: 1, anginit: 180, name: 'as11', row: 2, col: 2}))
  // forms.push(getForm({depth: 2, rad: 30, sides: 6, wbase: 1, anginit: 180, name: 'as11', row: 2, col: 2}))
  // forms.push(getForm({depth: 3, rad: 15, sides: 6, wbase: 1, anginit: 180, name: 'as12', row: 2, col: 2}))
  forms.push(getForm({depth: 4, rad: 30, sides: 6, wbase: 1, anginit: 180, name: 'as13', row: 2, col: 2}))
  // forms.push(getForm({depth: 5, rad: 30, sides: 6, wbase: 1, anginit: 180, name: 'as21', row: 3, col: 1}))
  // forms.push(getForm({depth: 6, rad: 30, sides: 6, wbase: 1, anginit: 180, name: 'as22', row: 2, col: 2}))
  // forms.push(getForm({depth: 7, rad: 30, sides: 6, wbase: 1, anginit: 180, name: 'as23', row: 2, col: 3}))
  // forms.push(getForm({depth: 8, rad: 30, sides: 6, wbase: 1, anginit: 180, name: 'as31', row: 3, col: 1}))
  // forms.push(getForm({depth: 9, rad: 30, sides: 6, wbase: 1, anginit: 180, name: 'as32', row: 3, col: 2}))
  // forms.push(getForm({depth: 10, rad: 90, sides: 6, wbase: 1, anginit: 180, name: 'as33', row: 2, col: 2}))
  animas = forms


  // animas = [...animas, img] // h.img
  // animas = [...animas, animatter] // h.img
  /*******************************************
 *      @animaApi
 *
 */

  let animaApi = function animaApi () {
    __mapper('xs').m('store').apply({'type': 'UPDANIMA', 'caller': 'alima', 'animas': animas})
  }

  return animaApi
}

let __mapper = muonMapper.muonMapper()
__mapper({'muonAlima': muonAlima(__mapper)}).muonAlima(__mapper)
</script>
<body style='cursor:crosshair'></body>

